<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TRai's AI Agent</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-contrast: #ffffff;
      --bot: #eef2ff;
      --user: #e6fffb;
      --system: #fff7ed;
      --radius: 14px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background: var(--bg);
    }
    .wrap {
      max-width: 940px;
      margin: 36px auto;
      padding: 0 16px;
    }
    header {
      display:flex; align-items:center; gap: 12px; margin-bottom: 10px;
    }
    header h1 { font-size: 22px; margin: 0; }
    .badge { font-size: 12px; color: var(--primary); background: #e8f0ff; padding: 2px 8px; border-radius: 999px; }
    .toolbar {
      display:flex; align-items:center; gap: 10px; margin: 12px 0 16px;
    }
    input.session {
      width: 360px; max-width: 55vw;
      padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 8px;
      background: #fff; color: var(--text);
    }
    button {
      border: 0; padding: 9px 14px; border-radius: 10px; cursor: pointer; font-weight: 600;
      background: var(--primary); color: var(--primary-contrast);
    }
    button.secondary { background: #e2e8f0; color: #0f172a; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .panel {
      background: var(--panel); border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      padding: 0; overflow: hidden;
      display: grid; grid-template-rows: 1fr auto;
      height: min(70vh, 650px);
    }
    .chat {
      padding: 14px; overflow-y: auto; scroll-behavior: smooth;
      background: linear-gradient(#ffffff, #fbfdff);
    }
    
    /* Message rows: left for bot/system, right for user  */
    .msg {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: flex-start;
    }

    /* User messages appear on the RIGHT (avatar on the right) */
    .msg.user {
      flex-direction: row-reverse;
      justify-content: flex-start;   /* keeps bubble snug to the right */
    }

    /* Optional: slightly narrower bubbles so long lines look tidy */
    .msg .bubble { 
      max-width: 72ch;               /* or 70% if you prefer: max-width: 70%; */
    }
    
    .user .bubble { border-radius: 12px 12px 2px 12px; }      /* pointy bottom-right */
    .bot .bubble, .system .bubble { border-radius: 12px 12px 12px 2px; } /* pointy bottom-left */

    .avatar {
      width: 42px; height: 42px; border-radius: 50%; display:flex; align-items:center; justify-content:center;
      font-weight: 800; color: #fff;
    }
    .avatar.user { background: #14b8a6; }
    .avatar.bot { background: #6366f1; }
    .avatar.sys { background: #f59e0b; }
    .bubble {
      border-radius: 12px; padding: 12px 14px; line-height: 1.35;
      white-space: pre-wrap; word-wrap: break-word;
      border: 1px solid #e2e8f0;
    }
    .user .bubble { background: var(--user); }
    .bot .bubble { background: var(--bot); }
    .system .bubble { background: var(--system); color: #7c2d12; }
    .muted { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .composer {
      display:flex; gap: 10px; padding: 12px; border-top: 1px solid #e2e8f0; background: #fafbff;
    }
    .composer input[type="text"] {
      flex: 1; border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px 14px; font-size: 15px;
    }
    .footer-note { margin-top: 10px; color: var(--muted); font-size: 12px; }
    .typing { font-style: italic; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TRai's AI Agent</h1>
      <span class="badge">Powered by Spring AI & Open AI</span>
    </header>

    <div class="toolbar">
      <label for="sessionId"><span class="muted">Session ID:</span></label>
      <input id="sessionId" class="session" type="text" />
      <button id="newSessionBtn" class="secondary">New session</button>
    </div>

    <section class="panel">
      <div id="chat" class="chat" aria-live="polite"></div>

      <div class="composer">
        <input id="msg" type="text" placeholder="Type a message and press Enter…" autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
    </section>

    <p class="footer-note">Tip: try “What is my name?”, “Create an order for customer <code>tulsi</code> with status NEW”, or “What is the status of order 12345?”.</p>
  </div>

  <script>
    // ------- Elements -------
    const sessionIdInput = document.getElementById('sessionId');
    const newSessionBtn  = document.getElementById('newSessionBtn');
    const chatWindow     = document.getElementById('chat');
    const msgInput       = document.getElementById('msg');
    const sendBtn        = document.getElementById('sendBtn');

    // ------- Utilities -------
    const uuid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() :
      'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8); return v.toString(16);
      });

    function scrollToBottom() {
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendMessage(kind, who, text) {
      const wrapper = document.createElement('div');
      wrapper.className = `msg ${kind}`;

      const avatar = document.createElement('div');
      avatar.className = `avatar ${who}`;
      avatar.textContent = who === 'user' ? 'U' : (who === 'bot' ? 'A' : '!');
      wrapper.appendChild(avatar);

      const right = document.createElement('div');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      right.appendChild(bubble);

      wrapper.appendChild(right);
      chatWindow.appendChild(wrapper);
      scrollToBottom();
    }

    function appendUser(text)   { appendMessage('user', 'user', text); }
    function appendBot(text)    { appendMessage('bot', 'bot', text); }
    function appendSystem(text) { appendMessage('system', 'sys', text); }

    // ------- Session handling -------
    function setSession(id) {
      sessionIdInput.value = id;
      localStorage.setItem('trai.sessionId', id);
    }

    // Your requested behavior:
    newSessionBtn.addEventListener('click', () => {
      setSession(`s-${uuid()}`);
      chatWindow.innerHTML = '';        // clear previous messages
      appendSystem('Started a new session.');
      msgInput.focus();
    });

    // ------- Send logic -------
    async function sendMessage() {
      const message = msgInput.value.trim();
      if (!message) return;

      const sessionId = sessionIdInput.value.trim();
      if (!sessionId) {
        appendSystem('No session ID. Starting a new session for you.');
        setSession(`s-${uuid()}`);
      }

      // UI feedback
      appendUser(message);
      msgInput.value = '';
      msgInput.focus();
      sendBtn.disabled = true;

      const typing = document.createElement('div');
      typing.className = 'muted typing';
      typing.textContent = 'Agent is thinking…';
      chatWindow.appendChild(typing);
      scrollToBottom();

      try {
        const res = await fetch('/api/agent/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: sessionIdInput.value, message })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }
        const data = await res.json();
        typing.remove();
        appendBot(data.reply ?? '(no reply)');
      } catch (err) {
        typing.remove();
        appendSystem('Error: ' + err.message);
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    }

    // ------- Wire up events -------
    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // ------- Boot -------
    (function init() {
      const saved = localStorage.getItem('trai.sessionId');
      setSession(saved || `s-${uuid()}`);
      appendSystem('Ready. You can start chatting.');
      msgInput.focus();
    })();
  </script>
</body>
</html>
